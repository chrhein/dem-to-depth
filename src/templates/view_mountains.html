<!DOCTYPE html>
<html lang="no">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/pannellum/2.5.6/pannellum.js"
            integrity="sha512-EmZuy6vd0ns9wP+3l1hETKq/vNGELFRuLfazPnKKBbDpgZL0sZ7qyao5KgVbGJKOWlAFPNn6G9naB/8WnKN43Q=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
        <link
            rel="stylesheet"
            type="text/css"
            href="{{ url_for('static', filename='styling/index.css') }}"
        />
        <script src="{{ url_for('static', filename='scripts/tools.js') }}"></script>
        <script src="jquery.js"></script>
        <script>
            $(function () {
                $('#folium-map').load(
                    "{{ url_for('static', filename='foliums/2021-04-17--pic03--Lyderhorn.html') }}"
                )
            })
        </script>
        <title>E2 - View Mountains</title>
    </head>
    <body>
        <div class="px-4 py-4 my-4 text-center">
            <h3 class="fw-bold text-start">Mountain Overlay</h3>
            <div class="p-3 border bg-light">
                <div class="d-grid d-sm-flex justify-content-sm-center">
                    <div id="mountain-overlay"></div>
                </div>
            </div>
        </div>
        <div class="px-4 py-4 my-4 text-center">
            <h3 class="fw-bold text-start">Interactive Map</h3>
            <div class="p-3 border bg-light">
                <div class="d-grid d-sm-flex justify-content-sm-center">
                    <div id="folium-container">
            <object
                id="folium-map"
                data="src/static/foliums/{{pano_filename}}.html"
            ></object>
                </div>
            </div>
        </div>

        <script>
            const mountains = JSON.parse('{{ hs | tojson | safe }}')
            const viewDirection = parseFloat('{{ yaw }}')

            function hotspot(hotSpotDiv, args) {
                hotSpotDiv.classList.add('mountain-tooltip')
                var span = document.createElement('span')
                span.innerHTML = args
                hotSpotDiv.appendChild(span)
                span.style.width = span.scrollWidth - 20 + 'px'
                span.style.marginLeft =
                    -(span.scrollWidth - hotSpotDiv.offsetWidth) / 2 - 9.5 + 'px'
                span.style.marginTop = -span.scrollHeight - 12 + 'px'
            }

            var mns = Object.values(
                Object.entries(mountains).map(function (d) {
                    const [key, value] = d
                    const lat = value.latitude
                    const lon = value.longitude
                    const url = `https://www.google.com/maps/search/${lat},${lon}/`
                    console.log(value.yaw)
                    
                    return {
                        yaw: viewDirection + parseFloat(value.yaw),
                        pitch: value.pitch,
                        cssClass: 'custom-hotspot mountain-hotspot',
                        createTooltipArgs: key,
                        createTooltipFunc: hotspot,
                        URL: url,
                    }
                })
            )

            viewer = pannellum.viewer('mountain-overlay', {
                type: 'equirectangular',
                panorama: '{{ render_path }}',
                autoLoad: true,
                yaw: parseFloat(viewDirection),
                compass: true,
                doubleClickZoom: false,
                mouseZoom: false,
                keyboardZoom: false,
                hotSpots: mns,
            })
        </script>
    </body>
</html>
