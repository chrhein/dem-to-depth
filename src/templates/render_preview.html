<!DOCTYPE html>
<html lang="no">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

        <script type="text/javascript">
            AFRAME.registerComponent('drag-rotate-component', {
                schema: { speed: { default: 1 } },
                init: function () {
                    this.ifMouseDown = false
                    this.opacityDecreased = false
                    this.ifShiftKeyDown = false
                    this.x_cord = 0
                    this.y_cord = 0

                    var curvedImagePano =
                        document.getElementById('curvedImagePano')

                    var cylinderImageRender = document.getElementById(
                        'cylinderImageRender'
                    )

                    this.viewDirection =
                        cylinderImageRender.getAttribute('rotation').y

                    this.yHeight =
                        cylinderImageRender.getAttribute('position').y

                    document.addEventListener(
                        'mousedown',
                        this.OnDocumentMouseDown.bind(this)
                    )
                    document.addEventListener(
                        'mouseup',
                        this.OnDocumentMouseUp.bind(this)
                    )
                    document.addEventListener(
                        'mousemove',
                        this.OnDocumentMouseMove.bind(this)
                    )
                    document.addEventListener(
                        'keydown',
                        this.OnDocumentKeyDown.bind(this)
                    )
                    document.addEventListener(
                        'keyup',
                        this.OnDocumentKeyUp.bind(this)
                    )
                },
                OnDocumentMouseDown: function (event) {
                    this.ifMouseDown = true
                    this.x_cord = event.clientX
                    this.y_cord = event.clientY
                },
                OnDocumentMouseUp: function () {
                    this.ifMouseDown = false
                    curvedImagePano.setAttribute('opacity', '1')
                    this.opacityDecreased = false
                },
                OnDocumentMouseMove: function (event) {
                    if (this.ifMouseDown && this.ifShiftKeyDown) {
                        if (!this.opacityDecreased) {
                            curvedImagePano.setAttribute('opacity', '0.25')
                            this.opacityDecreased = true
                        }
                        var temp_y = event.clientY - this.y_cord
                        var new_y = (this.yHeight - temp_y) * 0.005
                        cylinderImageRender.setAttribute('position', {
                            x: 0,
                            y: new_y,
                            z: 0,
                        })
                        this.yHeight = new_y
                    } else if (this.ifMouseDown) {
                        if (!this.opacityDecreased) {
                            curvedImagePano.setAttribute('opacity', '0.25')
                            this.opacityDecreased = true
                        }
                        var temp_x = this.x_cord - event.clientX
                        var new_x = (this.viewDirection + temp_x) * 0.1
                        cylinderImageRender.setAttribute('rotation', {
                            x: 0,
                            y: new_x,
                            z: 0,
                        })
                        this.viewDirection = new_x
                    }
                },
                OnDocumentKeyDown: function (event) {
                    if (event.keyCode == 16) {
                        this.ifShiftKeyDown = true
                    }
                },
                OnDocumentKeyUp: function (event) {
                    if (event.keyCode == 16) {
                        this.ifShiftKeyDown = false
                    }
                },
            })
        </script>
        <title>E2 - DEM Rendering</title>
    </head>
    <body>
        <a-scene cursor="rayOrigin:mouse">
            <a-assets>
                <img id="render" src="src/static/render.png" />
                <img id="pano" src="src/static/panorama1.jpg" />
            </a-assets>

            <a-entity light="type: ambient; color: #FFF"></a-entity>

            <a-plane
                position="0 -2.25 0"
                rotation="-90 0 0"
                width="10"
                height="10"
                color="#7BC8A4"
            ></a-plane>

            <a-cylinder
                id="cylinderImageRender"
                src="#render"
                side="back"
                material="side: back; repeat: -1 1"
                open-ended="true"
                position="0 0 0"
                height="4.5"
                radius="5"
                drag-rotate-component
            ></a-cylinder>

            <a-camera
                position="0 0 0"
                look-controls="enabled:false"
                wasd-controls-enabled="false"
            >
                <a-curvedimage
                    src="#pano"
                    id="curvedImagePano"
                    position="0 0 0"
                    height="3"
                    radius="4.95"
                    theta-length="90"
                    rotation="0 135 0"
                >
                </a-curvedimage>
            </a-camera>
        </a-scene>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
    </body>
</html>
