<!DOCTYPE html>
<html lang="no">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/pannellum/2.5.6/pannellum.css"
            integrity="sha512-UoT/Ca6+2kRekuB1IDZgwtDt0ZUfsweWmyNhMqhG4hpnf7sFnhrLrO0zHJr2vFp7eZEvJ3FN58dhVx+YMJMt2A=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/pannellum/2.5.6/pannellum.js"
            integrity="sha512-EmZuy6vd0ns9wP+3l1hETKq/vNGELFRuLfazPnKKBbDpgZL0sZ7qyao5KgVbGJKOWlAFPNn6G9naB/8WnKN43Q=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>

        <style>
            * {
                padding: 0;
                margin: 0;
            }

            #render-preview {
                width: 100vw;
                height: 85vh;
            }

            #coordinates {
                background: #e9e9e9;
                width: 100vw;
                height: 15vh;
            }

            .custom-hotspot {
                height: 1.25rem;
                width: 1.25rem;
                background: #f00;
                border-radius: 50%;
            }
        </style>
        <title>E2 - Render Preview</title>
    </head>
    <body>
        <div id="render-preview"></div>
        <div id="coordinates">
            <h5>Choose three recognizable points in the render.</h5>
            <div id="selected-coordinates">
                Press Shift while clicking to select a location. Press "C" to
                clear selection.
            </div>
            <form
                id="submit-coordinates"
                method="POST"
                action="/save_coordinates"
                enctype="multipart/form-data"
            ></form>
        </div>
        <script>
            var clickedCoords = []
            var shiftPressed = false

            viewer = pannellum.viewer('render-preview', {
                type: 'equirectangular',
                panorama: '{{render_path}}',
                autoLoad: true,
                yaw: 0,
                hfov: 180,
                pitch: 0,
                roll: 0,
                compass: true,
                northOffset: 0,
                vaov: 100,
                vOffset: 0,
                minPitch: -80,
                maxPitch: 80,
                doubleClickZoom: false,
                mouseZoom: false,
                keyboardZoom: false,
            })

            viewer.on('mousedown', function (event) {
                if (shiftPressed && clickedCoords.length <= 2) {
                    clickedCoords.push(viewer.mouseEventToCoords(event))
                    document.getElementById('selected-coordinates').innerHTML =
                        'Number of clicked locations: ' +
                        clickedCoords.length +
                        '/3 '
                    viewer.addHotSpot({
                        id: 'selected-location-' + clickedCoords.length,
                        pitch: clickedCoords[clickedCoords.length - 1][0],
                        yaw: clickedCoords[clickedCoords.length - 1][1],
                        cssClass: 'custom-hotspot',
                    })
                    if (clickedCoords.length == 3) {
                        addSubmitButton()
                    }
                }
            })
            document.addEventListener('keydown', function (event) {
                if (event.keyCode == 16) {
                    shiftPressed = true
                }
            })
            document.addEventListener('keyup', function (event) {
                if (event.keyCode == 16) {
                    shiftPressed = false
                }
            })
            document.addEventListener('keydown', function (event) {
                if (event.keyCode == 67) {
                    for (var i = 1; i <= clickedCoords.length; i++) {
                        viewer.removeHotSpot('selected-location-' + i)
                    }
                    clickedCoords = []
                    document
                        .getElementById('submit-coordinates')
                        .replaceChildren()
                    document.getElementById('selected-coordinates').innerHTML =
                        'Number of clicked locations: ' +
                        clickedCoords.length +
                        '/3'
                }
            })

            function addSubmitButton() {
                var td = document.getElementById('submit-coordinates')
                var coordinates = document.createElement('input')
                coordinates.setAttribute('type', 'hidden')
                coordinates.setAttribute('name', 'coordinates')
                coordinates.setAttribute('value', JSON.stringify(clickedCoords))
                td.appendChild(coordinates)
                var submitButton = document.createElement('input')
                submitButton.setAttribute('type', 'submit')
                submitButton.setAttribute('value', 'Submit')
                submitButton.setAttribute('class', 'btn btn-primary')
                td.appendChild(submitButton)
            }
        </script>
    </body>
</html>
